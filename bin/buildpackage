#! /bin/bash
#
# make a distribution for a python package (tar.gz, debian)
#


function cond_continue() {
    # demande confirmation, quitte si non
    echo -n "Continuer [y/N] ? "
    read _a
    if [ "$_a" = "y" ]; then
	return 
    fi
    exit 1
}

function build_source_package() {
    SRCDIR=$1
    echo '********** SOURCE DISTRIBUTION'
    if [ "$PYTHONVER" = "" ] ; then
	PYTHON=/usr/bin/python
    else
	PYTHON=/usr/bin/python$PYTHONVER
    fi
    pushd $SRCDIR
    $PYTHON setup.py sdist --force-manifest
    if [ $? -ne 0 ] ; then
	echo 'Error while building package !!!'
	exit 1
    fi
    popd
    mv $SRCDIR/dist/* ./dist
}

function build_debian_package() {
    SRCDIR=$1
    echo '********** DEBIAN PACKAGE'
    if [ "$DEBUILDER" = "" ]; then
        export DEBUILDER="pdebuild"
    fi
    echo '*-*-*-*-*-*-*-' DEBUILDER = $DEBUILDER
    echo '** PREPARE'
    DEST=$PWD/dist 
    pushd $SRCDIR
    buildeb $DEST
    rm -rf MANIFEST dist
    popd
}

if [ "$1" = "" -o "$1" = "--help" -o "$1" = "-h" ]; then
    echo "USAGE: buildpackage <source_directory> [bdist_wininst|sdist|deb]"
    echo "if the second argument is omitted, default is deb"
else
    # exit immediatly on error
    set -e
    renice +19 $$

    mkdir -p ./dist

    if [ "$2" = "sdist" ]; then
	build_source_package $1
    else
	build_debian_package $1
    fi
fi
