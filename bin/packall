#!/bin/python

import sys, os, shutil
import optparse
import tempfile

from logilab.common.textutils import colorize_ansi

debuilder = 'DEBUILDER=/home/nico/encours/forests/cubicweb_forest/logilab/devtools/bin/vbuild'
pythonpath = 'PYTHONPATH=/home/nico/encours/forests/cubicweb_forest/'

def package(target, version, options):
    print colorize_ansi('packaging %s' % target, color='yellow')
    os.system('hg clone %s' % target)
    #print os.listdir('.')
    for dist in 'lenny sid hardy'.split():
        cmd = 'lgp build -d %s %s --post-treatments' % (dist, os.path.basename(target))
        if options.verbose:
            cmd += ' -v'
        #print cmd
        os.system(cmd)

def get_parser():
    parser = optparse.OptionParser()
    parser.usage = 'packall [options] <what-to-pack> ...'
    #parser.min_args, parser.max_args = 0, 0
    parser.add_option("-l", "--list", dest="list",
                      help="list of packages sources and versions", metavar="LIST")
    parser.add_option("-v", "--verbose", dest="verbose",
                      action="store_true", default=False)
    return parser

def run(args):
    curdir = os.getcwd()
    workdir = tempfile.mkdtemp()
    os.chdir(workdir)
    parser = get_parser()
    (options, args) = parser.parse_args(args)
    if options.list:
        stream = file(options.list)
    else:
        stream = sys.stdin
    targets = dict([line.split() for line in stream])
    if args:
        for arg in args:
            for target, version in targets.items():
                if arg in target:
                    package(target, version, options)
    else:
        for target, version in targets.items():
            package(target, version, options)
    os.chdir(curdir)
    shutil.rmtree(workdir)
                
if __name__ == '__main__':
    run(sys.argv[1:])
